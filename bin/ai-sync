#!/usr/bin/env bash
set -euo pipefail

PROFILE="${1:-web}"

# Find repo root (must be inside a git repo)
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${REPO_ROOT}" ]]; then
  echo "Error: ai-sync must be run inside a git repository." >&2
  exit 1
fi

AI_RULES_DIR="${REPO_ROOT}/ai-rules"
if [[ ! -d "${AI_RULES_DIR}" ]]; then
  echo "Error: expected ai-rules at ${AI_RULES_DIR}. Run ai-install first." >&2
  exit 1
fi

SRC="${AI_RULES_DIR}/profiles/${PROFILE}"
if [[ ! -d "${SRC}" ]]; then
  echo "Error: profile '${PROFILE}' not found at ${SRC}" >&2
  exit 1
fi

# Ensure destinations exist
mkdir -p "${REPO_ROOT}/.github/prompts"
mkdir -p "${REPO_ROOT}/.claude/skills"

# 1) Instructions
cp -f "${SRC}/instructions/AGENTS.md" "${REPO_ROOT}/AGENTS.md"
cp -f "${SRC}/instructions/CLAUDE.md" "${REPO_ROOT}/CLAUDE.md"

mkdir -p "${REPO_ROOT}/.github"
cp -f "${SRC}/instructions/copilot-instructions.md" "${REPO_ROOT}/.github/copilot-instructions.md"

# Never overwrite local-only Claude memory if present
# (We also won't create it here.)
# If you want one, create it manually as CLAUDE.local.md in repo root.

# 2) Copilot prompts (overwrite; delete prompts removed from source)
rsync -a --delete "${SRC}/prompts/" "${REPO_ROOT}/.github/prompts/"

# 3) Claude skills (overwrite; delete skills removed from source)
rsync -a --delete "${SRC}/claude/skills/" "${REPO_ROOT}/.claude/skills/"

# 4) Root scripts (overwrite)
if [[ -d "${SRC}/scripts" ]]; then
  rsync -a "${SRC}/scripts/" "${REPO_ROOT}/"
  # Make *.sh executable
  find "${REPO_ROOT}" -maxdepth 1 -type f -name "*.sh" -exec chmod +x {} \;
fi

echo "ai-sync: synced profile '${PROFILE}' into ${REPO_ROOT}"
