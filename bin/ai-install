#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   ./ai-install --repo git@github.com:you/ai-rules.git --profile web
#
# Behavior:
# - Clones ai-rules into ./ai-rules at the repo root (if missing)
# - Runs ./ai-rules/bin/ai-sync <profile>

REPO_URL=""
PROFILE="web"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo)
      REPO_URL="$2"
      shift 2
      ;;
    --profile)
      PROFILE="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: ai-install --repo <git-url> [--profile web|mobile]"
      exit 0
      ;;
    *)
      echo "Unknown arg: $1" >&2
      exit 1
      ;;
  esac
done

if [[ -z "${REPO_URL}" ]]; then
  echo "Error: --repo is required (e.g. git@github.com:<you>/ai-rules.git)" >&2
  exit 1
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${REPO_ROOT}" ]]; then
  echo "Error: ai-install must be run inside a git repository." >&2
  exit 1
fi

DEST="${REPO_ROOT}/ai-rules"

if [[ -d "${DEST}/.git" ]]; then
  echo "ai-install: ai-rules already exists at ${DEST}"
else
  if [[ -e "${DEST}" ]]; then
    echo "Error: ${DEST} exists but is not a git repo. Move it aside and retry." >&2
    exit 1
  fi
  echo "ai-install: cloning ${REPO_URL} into ${DEST}"
  git clone "${REPO_URL}" "${DEST}"
fi

if [[ ! -x "${DEST}/bin/ai-sync" ]]; then
  echo "Error: ${DEST}/bin/ai-sync not found or not executable." >&2
  exit 1
fi

"${DEST}/bin/ai-sync" "${PROFILE}"
echo "ai-install: done"
